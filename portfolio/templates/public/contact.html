{% extends "layout/base.html" %}
{% block title %}{{ t('contact') }} – Carlos Sibrian{% endblock %}

{% block content %}
<div id="contact-panel" class="contact-container full-screen-section position-relative" style="z-index: 10;">

  <div class="row g-5 align-items-stretch w-100 m-0">

    <div class="col-lg-5">
      <div class="glass-panel contact-info-box h-100 p-5 d-flex flex-column justify-content-center">
        <h1 class="display-3 fw-bold text-white mb-3" style="text-shadow: 0 0 30px rgba(0,0,0,0.5);">
          {{ t('contact') }}
        </h1>
        <p class="text-muted fs-5 mb-4" style="letter-spacing: 1px;">
          Hablemos de tu próximo proyecto <span class="text-accent blink">_</span>
        </p>

        <div class="contact-info-block">
          <p class="text-white-50 fs-6" style="line-height: 1.8;">
            ¿Tienes una idea innovadora o necesitas ayuda con desarrollo?
            <br><br>
            Este canal es la vía más rápida para contactarme directamente.
            Completa los datos y recibiré tu mensaje al instante en mi terminal.
          </p>
        </div>

      </div>
    </div>

    <div class="col-lg-7">
      <div class="glass-panel position-relative p-5 border-cyber h-100" style="overflow: hidden;">

        <div id="cipitio-entity" class="cipitio-sprite"></div>
        <div id="cipitio-rock" class="digital-rock"></div>
        <div class="ui-corner top-left"></div>
        <div class="ui-corner bottom-right"></div>
        <div class="scanline"></div>

        <form method="POST" action="{{ url_for('public.contact') }}" novalidate class="position-relative"
          style="z-index: 2;" id="contactForm">

          {{ form.hidden_tag() }}

          <div style="display: none;">{{ form.bot_catcher(class="cyber-input") }}</div>

          <div class="mb-4 group-cyber">
            <label class="cyber-label"><i data-feather="user" class="me-2"></i> {{ t(form.name.label.text) }}</label>
            {{ form.name(class="form-control cyber-input", placeholder="Tu nombre", id="inputName") }}
          </div>

          <div class="mb-4 group-cyber">
            <label class="cyber-label"><i data-feather="at-sign" class="me-2"></i> {{ t(form.email.label.text)
              }}</label>
            {{ form.email(class="form-control cyber-input", placeholder="name@example.com", id="inputEmail") }}
          </div>

          <div class="mb-5 group-cyber">
            <label class="cyber-label"><i data-feather="message-square" class="me-2"></i> {{ t(form.message.label.text)
              }}</label>
            {{ form.message(class="form-control cyber-input", rows="5", placeholder="Escribe tu mensaje...",
            id="inputMessage") }}
          </div>

          <button type="submit" id="submitBtn"
            class="btn btn-cyber w-100 py-3 d-flex align-items-center justify-content-center gap-2">
            <span id="btnText">ENVIAR MENSAJE</span><i data-feather="send" id="btnIcon"></i>
          </button>
        </form>
      </div>
    </div>

  </div>
</div>

<div id="cyber-modal" class="cyber-modal-overlay">
  <div class="cyber-modal-box">
    <h3 class="modal-title" id="modal-title">SISTEMA</h3>
    <div id="modal-message" class="modal-msg"></div>
    <button id="close-modal" class="btn-cyber-modal">ENTENDIDO</button>
  </div>
</div>

<div id="server-messages-data" data-messages='{{ get_flashed_messages(with_categories=true) | tojson }}'
  style="display:none"></div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof feather !== 'undefined') feather.replace();

    // --- REFERENCIAS FORM ---
    const form = document.getElementById('contactForm');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const originalBtnText = btnText ? btnText.innerText : 'ENVIAR MENSAJE';

    // --- MODAL ---
    const modal = document.getElementById('cyber-modal');
    const titleEl = document.getElementById('modal-title');
    const msgEl = document.getElementById('modal-message');
    const closeBtn = document.getElementById('close-modal');
    const modalBox = document.querySelector('.cyber-modal-box');
    const modalBtn = document.querySelector('.btn-cyber-modal');

    function showModal(title, msg, type = 'error') {
      titleEl.innerText = title;
      msgEl.innerHTML = msg;

      if (type === 'success') {
        modalBox.style.borderColor = '#00e5ff';
        modalBox.style.boxShadow = '0 0 30px rgba(0, 229, 255, 0.4)';
        titleEl.style.color = '#00e5ff';
        titleEl.style.borderBottomColor = 'rgba(0, 229, 255, 0.3)';
        modalBtn.style.color = '#00e5ff';
        modalBtn.style.borderColor = '#00e5ff';
        modalBtn.style.background = 'rgba(0, 229, 255, 0.1)';
      } else {
        modalBox.style.borderColor = '#ff0055';
        modalBox.style.boxShadow = '0 0 30px rgba(255, 0, 85, 0.4)';
        titleEl.style.color = '#ff0055';
        titleEl.style.borderBottomColor = 'rgba(255, 0, 85, 0.3)';
        modalBtn.style.color = '#ff0055';
        modalBtn.style.borderColor = '#ff0055';
        modalBtn.style.background = 'rgba(255, 0, 85, 0.1)';
      }
      modal.classList.add('active');
    }

    if (closeBtn) {
      closeBtn.addEventListener('click', () => { modal.classList.remove('active'); });
    }

    // --- VALIDACIÓN FORM ---
    if (form) {
      form.addEventListener('submit', function (e) {
        if (submitBtn.disabled) { e.preventDefault(); return; }

        const nameVal = document.getElementById('inputName').value.trim();
        const emailVal = document.getElementById('inputEmail').value.trim();
        const messageVal = document.getElementById('inputMessage').value.trim();

        let errors = [];

        if (!nameVal) errors.push("Por favor, ingresa tu nombre.");
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailVal) errors.push("El correo es obligatorio.");
        else if (!emailRegex.test(emailVal)) errors.push("El formato del correo no es válido.");
        if (!messageVal) errors.push("El mensaje no puede estar vacío.");

        if (errors.length > 0) {
          e.preventDefault();
          let errorHtml = '<ul style="text-align: left; margin-bottom: 0; padding-left: 20px;">';
          errors.forEach(err => errorHtml += `<li>${err}</li>`);
          errorHtml += '</ul>';
          showModal("FALTAN DATOS", errorHtml, 'error');
        } else {
          submitBtn.disabled = true;
          btnText.innerText = "ENVIANDO...";
          submitBtn.style.opacity = "0.7";
        }
      });
    }

    window.addEventListener('pageshow', function (event) {
      if (event.persisted && submitBtn) {
        submitBtn.disabled = false;
        btnText.innerText = originalBtnText;
        submitBtn.style.opacity = "1";
      }
    });

    // --- MENSAJES SERVIDOR ---
    const serverMessagesElement = document.getElementById('server-messages-data');
    if (serverMessagesElement) {
      try {
        const serverMessages = JSON.parse(serverMessagesElement.dataset.messages || '[]');
        if (serverMessages && serverMessages.length > 0) {
          serverMessages.forEach(item => {
            const category = item[0];
            const message = item[1];
            let title = 'SISTEMA';
            if (category === 'success') title = 'ÉXITO';
            if (category === 'error') title = 'ERROR';

            showModal(title, message, category);
          });
        }
      } catch (e) {
        console.error("Error parsing server messages", e);
      }
    }
  });
</script>
{% endblock %}